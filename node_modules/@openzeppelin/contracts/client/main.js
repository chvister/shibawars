Moralis.initialize("VENnpo7F7P2IjpTpzdSxwbzbJ8XvfsZg8r8P01yC"); // Application id from moralis.io
Moralis.serverURL = "https://xmhlcuysesnk.moralis.io:2053/server"; //Server url from moralis.io

const CONTRACT_ADRESS = "0x2CB65C07623aB97B7215f54e187a4FF0E4870cA9";

async function init() {
    try {
        let user = Moralis.User.current();
        if(!user){
            $("#login_button").click(async () => {
                user = await Moralis.Web3.authenticate();
            })
        }
        renderGame();
    } catch (error) {
        console.log(error);
    }
}

async function renderGame(){
    $("#game").show();

    let shibaId = 0;
    window.web3 = await Moralis.Web3.enable();
    let contract = await getContract();
    let data = await contract.methods.getTokenDetails(shibaId).call({from: ethereum.selectedAddress});
    console.log(data);

    renderShiba(shibaId, data);

    $("#login_button").hide();
}

function renderShiba(id, data){
    $("#shiba-id").html(id);
    $("#shiba-name").html(data.name);
    $("#shiba-description").html(data.description);
    $("#shiba-level").html(data.level);
    $("#shiba-strength").html(data.strength);
    $("#shiba-agility").html(data.agility);
    $("#shiba-dexterity").html(data.dexterity);
    $("#btn-level-up").attr("data-shiba-id", id);
}

async function getContract(){
    let abi = await getAbi();
    return new web3.eth.Contract(abi, CONTRACT_ADRESS);
}

function getAbi(){
    return new Promise((res)=>{
        $.getJSON("Token.json", ((json) => {
            res(json.abi);
        }))
    })
}

async function levelUp(shibaId) {
    let contract = await getContract();
    contract.methods.levelUp(shibaId).send({from: ethereum.selectedAddress})
        .on("receipt", (() => {
            console.log("level up");
            renderGame();
        }));
}

$("#btn-level-up").click( () => { 
    let shibaId = $("#btn-level-up").attr("data-shiba-id");
    levelUp(shibaId);
})

init();